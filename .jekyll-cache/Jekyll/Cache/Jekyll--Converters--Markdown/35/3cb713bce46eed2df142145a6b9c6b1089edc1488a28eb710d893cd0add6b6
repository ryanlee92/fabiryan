I"<p>현재 재직중인 회사에서는 프론트엔드 프레임워크로 Flutter를 사용하고 있다.
그런데 오늘 업무를 하다 GIF를 리사이징해야 하는 상황이 있었는데, <code class="language-plaintext highlighter-rouge">flutter resize gif</code> 등의 키워드로 구글링을 해도 결과가 나오지 않았다.</p>

<p>결국 해결책을 발견하긴 했는데, 이 포스트가 같은 문제를 겪는 사람들에게 도움이 되길 바란다.</p>

<h2 id="사용되는-라이브러리">사용되는 라이브러리</h2>
<p>기본적으로 이미지를 고르는 <code class="language-plaintext highlighter-rouge">image_picker</code>를 사용하고, gif 리사이즈를 위해 FFmpeg 라이브러리를 사용했다.
FFmpeg 라이브러리는 크게 <code class="language-plaintext highlighter-rouge">flutter_ffmpeg</code>, <code class="language-plaintext highlighter-rouge">ffmpeg_kit_flutter</code>, <code class="language-plaintext highlighter-rouge">ffmpeg_cli</code> 등이있는데, discontinued 된 라이브러리긴 하지만 discontinued 되기 전부터 사용하고 있었던 <code class="language-plaintext highlighter-rouge">flutter_ffmpeg</code>를 사용하기로 했다. (기본적으로 ffmpeg를 사용하기 때문에 들어가는 쿼리는 동일하다. 따라서 어떤 라이브라리를 쓰더라도 ffmpeg를 쓰는 한 동일한 쿼리를 넣으면 된다.)</p>

<h2 id="resizing-method">Resizing Method</h2>
<p>먼저 <code class="language-plaintext highlighter-rouge">image_picker</code> 라이브러리에서 이미지를 선택한다. 선택한 이미지는 <code class="language-plaintext highlighter-rouge">XFile</code>이라는 타입을 반환하게 되는데, 리사이징하는 함수는 이 <code class="language-plaintext highlighter-rouge">XFile</code> 과 <code class="language-plaintext highlighter-rouge">BuildContext</code>를 받아서 만들게 된다.</p>

<p>함수 코드는 아래와 같다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="rouge-code"><pre>FutureOr&lt;Uint8List?&gt; resizeAndCropImage({required XFile image, required BuildContext context}) async {
    Uint8List? data;
    if (!kIsWeb &amp;&amp; image.path.split('.').last != 'gif') {
      data = await Utils.cropImage(image, context, 900, 900);
    } else {
      if (kIsWeb) {
        data = await image.readAsBytes();
      } else {
        FlutterFFmpeg _flutterFFmpeg = FlutterFFmpeg();

        String resizeFilePath = image.path.replaceAll('.gif', '_resize.gif');
        try {
          await _flutterFFmpeg.execute(
              '-i ${image.path} -filter_complex "[0:v] scale=320:-1:flags=lanczos,split [a][b]; [a] palettegen=reserve_transparent=on:transparency_color=ffffff [p]; [b][p] paletteuse" $resizeFilePath');

          data = await File(resizeFilePath).readAsBytes();
        } catch (e) {
          data = await image.readAsBytes();
        }
      }
    }
    return data;
}

Future&lt;Uint8List&gt; cropImage(XFile image, BuildContext context, int maxHeight, int maxWidth async {
    CroppedFile? croppedFile;
    croppedFile = await ImageCropper().cropImage(
        sourcePath: image.path,
        compressFormat: ImageCompressFormat.png,
        compressQuality: 100,
        aspectRatio: const CropAspectRatio(ratioX: 1, ratioY: 1),
        uiSettings: buildUiSettings(context),
        maxHeight: maxHeight,
        maxWidth: maxWidth);
    Uint8List cropped = await croppedFile!.readAsBytes();
    Uint8List compressedImage = await FlutterImageCompress.compressWithList(cropped, quality: 80);
    return compressedImage;
}
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="함수에-대한-설명">함수에 대한 설명</h3>
<p>먼저 gif인지 아닌지에 대해 판단을 한다. path의 마지막이 gif로 끝나는지 확인하고 gif가 아닌 일반 이미지라면 <code class="language-plaintext highlighter-rouge">FlutterImageCompress</code> 라이브러리를 통해 그냥 압축한다.</p>

<p>반면 gif라면 플랫폼이 웹일때는 압축이 불가능하고 (ffmpeg 라이브러리가 support하지 않는다.) 앱인 경우에는 <code class="language-plaintext highlighter-rouge">_flutterFFmpeg.execute</code> 안에 있는 쿼리를 통해 리사이즈 한다. 만약 이를 실패하면 압축을 포기하고 원래 값을 뱉는다.</p>

<h2 id="후기">후기</h2>
<p>FFmpeg라는 라이브러리에 대해 자세히 알지는 못하지만 이전에 비디오를 gif로 해당 라이브러리를 통해 변환했던 경험이 있어서 FFmpeg를 통해 gif를 리사이징 할 수 있을것이란 가설을 세웠는데, 그 가설이 적중했다. 다행히 <code class="language-plaintext highlighter-rouge">ffmpeg resize gif</code> 검색어로 구글링 했을때 관련 내용을 찾을 수 있었고 생각보다 쉽게 해결했다. 끝!</p>

<!-- 
---
layout: post
title:  "Inception Movie"
author: john
categories: [ Jekyll, tutorial ]
tags: [red, yellow]
image: assets/images/11.jpg
description: "My review of Inception movie. Actors, directing and more."
rating: 4.5
featured: true
hidden: false
beforetoc: "Markdown editor is a very powerful thing. In this article I'm going to show you what you can actually do with it, some tricks and tips while editing your post."
toc: true // 목차를 사용할 것인지
--- 
-->
:ET